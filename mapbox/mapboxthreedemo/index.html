<!doctype html>

<head>
    <title>Threebox Basic Example</title>
    <script src='https://npmcdn.com/@turf/turf/turf.min.js'></script>
    <script src="js/threebox.js" type="text/javascript"></script>

    <script src='js/mapbox-gl.js'></script>
    <link href='mapbox-gl.css' rel='stylesheet' />
    <script src='js/GLTFLoader.js'></script>
    <!-- <script src='https://api.mapbox.com/mapbox-gl-js/v0.50.0/mapbox-gl.js'></script>
    <link href='https://api.mapbox.com/mapbox-gl-js/v0.50.0/mapbox-gl.css' rel='stylesheet' /> -->
    <!-- <script src="https://cdn.rawgit.com/mrdoob/three.js/master/examples/js/loaders/GLTFLoader.js"></script> -->
    <style>
        body,
        html {
            width: 100%;
            height: 100%;
            margin: 0;
        }

        #map {
            width: 100%;
            height: 100%;
        }
    </style>
</head>

<body>
    <div id='map' class='map'></div>

    <script>

        var origin = [120.2340, 30.2353];
        var map = new mapboxgl.Map({
            container: 'map',
            style: "gaode_makalong2.json",
            // center: origin,
            center: [120.21093, 30.2263],
            zoom: 14.2,
            pitch: 60,
            heading: 41,
            hash: true
        });
        map.addControl(new mapboxgl.NavigationControl());

        var fromLL = function (lon, lat) {
            // derived from https://gist.github.com/springmeyer/871897
            var extent = 20037508.34;

            var x = lon * extent / 180;
            var y = Math.log(Math.tan((90 + lat) * Math.PI / 360)) / (Math.PI / 180);
            y = y * extent / 180;

            return [(x + extent) / (2 * extent), 1 - ((y + extent) / (2 * extent))];
        }
        var translate = fromLL(120.224504470, 30.23155861728);//萧山体育馆 白莲花

        var transform = {
            translateX: translate[0],
            translateY: translate[1],
            translateZ: 0,
            rotateX: Math.PI / 2,
            rotateY: 0,
            rotateZ: 0,
            scale: 50.41843220338983e-8//设置模型大小
        }

        const THREE = window.THREE;

        class CustomLayer {
            constructor() {
                this.id = 'custom_layer_building';
                this.type = 'custom';


                this.camera = new THREE.Camera();
                this.scene = new THREE.Scene();

                const directionalLight = new THREE.DirectionalLight(0xffffff);
                directionalLight.position.set(0, -70, 100).normalize();
                this.scene.add(directionalLight);

                const directionalLight2 = new THREE.DirectionalLight(0xffffff);
                directionalLight2.position.set(0, 70, 100).normalize();
                this.scene.add(directionalLight2);

                var loader = new THREE.GLTFLoader();
                loader.load('buildingtower/34M_17.gltf', (function (gltf) {
                    this.scene.add(gltf.scene);
                }).bind(this));
            }

            onAdd(map, gl) {
                this.map = map;

                this.renderer = new THREE.WebGLRenderer({
                    canvas: map.getCanvas(),
                    context: gl
                });

                this.renderer.autoClear = false;
            }

            render3D(gl, matrix) {
                const rotationX = new THREE.Matrix4().makeRotationAxis(new THREE.Vector3(1, 0, 0), transform.rotateX);
                const rotationY = new THREE.Matrix4().makeRotationAxis(new THREE.Vector3(0, 1, 0), transform.rotateY);
                const rotationZ = new THREE.Matrix4().makeRotationAxis(new THREE.Vector3(0, 0, 1), transform.rotateZ);

                const m = new THREE.Matrix4().fromArray(matrix);
                const l = new THREE.Matrix4().makeTranslation(transform.translateX, transform.translateY, transform.translateZ)
                    .scale(new THREE.Vector3(transform.scale, -transform.scale, transform.scale))
                    .multiply(rotationX)
                    .multiply(rotationY)
                    .multiply(rotationZ);

                this.camera.projectionMatrix.elements = matrix;
                this.camera.projectionMatrix = m.multiply(l);
                this.renderer.state.reset();
                this.renderer.render(this.scene, this.camera);
                this.map.triggerRepaint();
            }
        }


        function getRotationy(point1, point2) {
            var x1 = point1[0];
            var y1 = point1[1];
            var x2 = point2[0];
            var y2 = point2[1];

            var xmove = x2 - x1;
            var ymove = y2 - y1;

            if (xmove > 0 && ymove > 0) {//东北
                return 180 - Math.atan(ymove / xmove) * 180 / Math.PI;
            } else if (xmove > 0 && ymove == 0) {//东
                return 180;
            } else if (xmove > 0 && ymove < 0) {//东南
                return 180 - Math.atan(ymove / xmove) * 180 / Math.PI;
            } else if (xmove == 0 && ymove > 0) {//北
                return 90;
            } else if (xmove == 0 && ymove == 0) {//重合
                return null;
            } else if (xmove == 0 && ymove < 0) {//南
                return -90;
            } else if (xmove < 0 && ymove > 0) {//西北
                return -Math.atan(ymove / xmove) * 180 / Math.PI;
            } else if (xmove < 0 && ymove == 0) {//西
                return 0;
            } else if (xmove < 0 && ymove < 0) {//西南
                return -Math.atan(ymove / xmove) * 180 / Math.PI;
            }
        }
        const boatCoordinatesSub = [
          [
            120.32295227050781,
            30.273893434326062
          ],
          [
            120.30853271484375,
            30.28397399248833
          ],
          [
            120.29960632324219,
            30.287531589298727
          ],
          [
            120.28793334960936,
            30.290496154756223
          ],
          [
            120.27900695800781,
            30.289310339324643
          ],
          [
            120.27214050292967,
            30.28634573802957
          ],
          [
            120.26321411132812,
            30.28397399248833
          ],
          [
            120.25360107421874,
            30.27982329983024
          ],
          [
            120.2446746826172,
            30.278044377800153
          ],
          [
            120.2405548095703,
            30.27270741823115
          ],
          [
            120.23574829101562,
            30.266777122804427
          ],
          [
            120.23094177246094,
            30.259067203213018
          ],
          [
            120.22201538085938,
            30.246018268082167
          ],
          [
            120.21034240722655,
            30.23712027316867
          ],
          [
            120.20484924316406,
            30.22940802598824
          ],
          [
            120.19592285156249,
            30.2240684235559
          ],
          [
            120.18424987792969,
            30.21576179908697
          ],
          [
            120.17120361328125,
            30.208047876887466
          ],
          [
            120.15884399414062,
            30.203893976001527
          ],
          [
            120.14167785644531,
            30.200333349994086
          ],
          [
            120.1306915283203,
            30.195585648311063
          ],
          [
            120.12519836425781,
            30.18905718468536
          ],
          [
            120.11833190917967,
            30.180747605060766
          ],
          [
            120.11970520019533,
            30.169469197331733
          ],
          [
            120.12382507324219,
            30.15462722077597
          ],
          [
            120.13137817382811,
            30.1457209625174
          ],
          [
            120.13824462890625,
            30.1380015549519
          ],
          [
            120.15060424804689,
            30.132656995972482
          ],
          [
            120.16021728515624,
            30.1267182577001
          ],
          [
            120.1703453063965,
            30.12033371563661
          ],
          [
            120.1739501953125,
            30.11632460616683
          ],
          [
            120.17669677734374,
            30.112909310487694
          ],
          [
            120.17583847045898,
            30.109642395437696
          ],
          [
            120.17240524291992,
            30.10667237892414
          ],
          [
            120.16519546508789,
            30.104444807954295
          ],
          [
            120.15026092529297,
            30.0964251367153
          ],
          [
            120.13412475585936,
            30.08691949863084
          ],
          [
            120.12073516845703,
            30.082760494617915
          ],
          [
            120.1028823852539,
            30.07889840572334
          ],
          [
            120.08605957031249,
            30.071470887901302
          ],
          [
            120.0750732421875,
            30.064934211006477
          ],
          [
            120.05722045898439,
            30.05423689944282
          ],
          [
            120.04692077636719,
            30.04651034452601
          ],
          [
            120.0373077392578,
            30.042349642213367
          ],
          [
            120.02426147460936,
            30.041160838027047
          ],
          [
            120.01602172851562,
            30.04532159026885
          ]
        ];
        
        map.on('style.load', function () {
        // map.on('load', function () {
            // map.addLayer({//航线
            //     "id": "route",
            //     "type": "line",
            //     "source": {
            //         "type": "geojson",
            //         "data": {
            //             "type": "Feature",
            //             "properties": {},
            //             "geometry": {
            //                 "type": "LineString",
            //                 "coordinates": boatCoordinates
            //             }
            //         }
            //     },
            //     "layout": {
            //         "line-join": "round",
            //         "line-cap": "round"
            //     },
            //     "paint": {
            //         "line-color": "#888",
            //         "line-width": 8
            //     }
            // });


            map.addLayer({//建筑白模
                "id": "building-3d",
                "type": "fill-extrusion",
                "metadata": {},
                "source": "openmaptiles",
                "source-layer": "building",
                "minzoom": 14,
                "layout": {
                    "visibility": "visible"
                },
                "paint": {
                    "fill-extrusion-color": "rgba(189, 185, 181, 1)",
                    "fill-extrusion-height": {
                        "property": "render_height",
                        "type": "identity"
                    },
                    "fill-extrusion-base": {
                        "property": "render_min_height",
                        "type": "identity"
                    },
                    "fill-extrusion-opacity": 0.3
                },
                "filter": [
                    "all",
                    [
                        "!has",
                        "hide_3d"
                    ]
                ]
            });

            map.addLayer(new CustomLayer());
            map.addLayer({//航行的轮船
                id: 'custom_layer',
                type: 'custom',
                onAdd: function (map, mbxContext) {
                    window.threebox = new Threebox(map, mbxContext);
                    threebox.setupDefaultLights();//设置默认灯光效果
                    var sceneboat = null;

                    var loader = new THREE.GLTFLoader();
                    loader.load('srlandet/scene.gltf',
                        function (result) {
                            sceneboat = result.scene;
                            result.scene.rotation.x = -Math.PI * 1.5;
                            threebox.addAtCoordinate(result.scene, origin, { preScale: 0.2 });

                            const line = turf.lineString(boatCoordinatesSub);
                            const lineLength = turf.length(line);
                            console.log({ lineLength });
                            const DURATION = 200000;
                            budge();
                            function budge(timestamp = 0.000001) {//循环设置位置实现播放轨迹
                                const offsetLine = turf.lineSliceAlong(line, 0, lineLength * (timestamp % DURATION) / DURATION);
                                const pointarr = offsetLine.geometry.coordinates;
                                const point = offsetLine.geometry.coordinates.pop();

                                var pointPrevious = offsetLine.geometry.coordinates[pointarr.length - 1];
                                if (pointPrevious) {

                                    var raotationy = getRotationy(pointPrevious, point);
                                    if (raotationy) {

                                        result.scene.rotation.y = -raotationy * Math.PI / 180;
                                    }
                                }
                                // result.scene.rotation.y =-0.5*Math.PI;
                                threebox.moveToCoordinate(sceneboat, point,{ preScale: 0.2 })
                                requestAnimationFrame(budge);
                            }


                            // var curved = turf.bezierSpline(line,{resolution:90000});
                            // var index = 0;
                            // budge();
                            //     function budge() {
                            //         index++;
                            //         var point = curved.geometry.coordinates[index];

                            //             var pointNext = curved.geometry.coordinates[index+1];
                            //             var raotationy = getRotationy(point,pointNext);
                            //             if(raotationy){

                            //                 result.scene.rotation.y = raotationy;
                            //             }
                            //         threebox.moveToCoordinate(sceneboat, point)
                            //         requestAnimationFrame(budge);
                            //     }
                        },
                        function (xhr) {
                            console.log((xhr.loaded / xhr.total * 100) + '% loaded');
                        },
                        function (err) {
                            console.log('An error happened');
                        }
                    );


                },

                render: function (gl, matrix) {
                    threebox.update(true);
                }
            });
        });
    </script>
</body>